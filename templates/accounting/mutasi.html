{% set page_title = "Mutasi Akunting" %}
{% extends "base.html" %}

{% block content %}
<div class="container mt-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-semibold"><i class="bi bi-journal-text me-2 text-primary"></i>Mutasi Keuangan</h3>
  </div>

  <!-- Filter Form -->
  <form method="POST" class="mb-4 row g-2 align-items-end">
    <div class="col-md-3">
      <label class="form-label fw-semibold mb-1">Periode</label>
      <select name="mode" id="mode" class="form-select">
        <option value="all" {% if selected_mode == 'all' %}selected{% endif %}>Semua</option>
        <option value="daily" {% if selected_mode == 'daily' %}selected{% endif %}>Harian</option>
        <option value="monthly" {% if selected_mode == 'monthly' %}selected{% endif %}>Bulanan</option>
        <option value="yearly" {% if selected_mode == 'yearly' %}selected{% endif %}>Tahunan</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label fw-semibold mb-1">Dari</label>
      <input type="date" name="start_date" value="{{ request.form.get('start_date', '') }}" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label fw-semibold mb-1">Sampai</label>
      <input type="date" name="end_date" value="{{ request.form.get('end_date', '') }}" class="form-control">
    </div>
    <div class="col-md-3 d-flex gap-2">
      <button type="submit" class="btn btn-primary flex-fill"><i class="bi bi-funnel me-1"></i>Terapkan</button>
      <a href="{{ url_for('accounting.export_mutasi_pdf', mode=selected_mode) }}" 
         class="btn btn-danger flex-fill">
         <i class="bi bi-file-earmark-pdf me-1"></i>PDF
      </a>
    </div>
  </form>

  <!-- Table -->
  <div class="card p-3">
    <div class="table-responsive">
      <table id="tableMutasi" class="table table-striped table-bordered align-middle">
        <thead class="table-light">
          <tr class="text-center">
            <th style="width:90px;">Tanggal</th>
            <th>Kategori</th>
            <th>Deskripsi</th>
            <th>Sumber</th>
            <th>Akun</th>
            <th class="text-end">Jumlah (Rp)</th>
          </tr>
        </thead>
        <tbody>
          {% for m in mutations %}
          <tr>
            <td class="text-center">{{ m.date.strftime('%d/%m/%Y') }}</td>
            <td class="text-capitalize">{{ m.category }}</td>
            <td>{{ m.description or '-' }}</td>
            <td>{{ m.source or '-' }}</td>
            <td>{{ m.account or '-' }}</td>
            <td class="text-end {% if m.category=='income' %}text-success{% else %}text-danger{% endif %}">
              {{ "{:,.2f}".format(m.amount) }}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted py-3">
              <i class="bi bi-info-circle me-1"></i>Belum ada data mutasi untuk periode ini.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block footer %}
  © {{ 2025 }} Holycity Data Portal – Mutasi Akunting
{% endblock %}

{% block scripts %}
<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script>
  $(document).ready(function() {
    $('#tableMutasi').DataTable({
      language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/id.json' },
      pageLength: 10,
      order: [[0, 'desc']],
      responsive: true
    });
  });
</script>
{% endblock %}