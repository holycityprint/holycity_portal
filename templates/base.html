<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}{{ title or "Holycity Portal" }}{% endblock %}</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    body{
      background-color:#f4f6f9;
      font-family:"Poppins","Segoe UI",Roboto,sans-serif;
      font-size:0.95rem;
    }
    nav.navbar{
      background:linear-gradient(90deg,#0052d4,#4364f7,#6fb1fc);
      box-shadow:0 3px 6px rgba(0,0,0,0.1);
    }
    .nav-link.active{font-weight:600;text-decoration:underline;}
    .nav-link:hover{opacity:0.85;text-decoration:underline;}
    .dropdown-menu{border-radius:8px;}
    .card{
      border:0;border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
      transition:transform .2s ease,box-shadow .2s ease;
    }
    .card:hover{transform:translateY(-4px);box-shadow:0 6px 16px rgba(0,0,0,0.12);}
    .btn{border-radius:8px;font-weight:500;transition:all .2s ease;}
    .btn:hover{transform:translateY(-1px);}
    .alert{border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
    footer{
      background:#fff;box-shadow:0 -1px 10px rgba(0,0,0,0.05);
      font-size:0.85rem;color:#777;text-align:center;
      margin-top:3rem;padding:1rem 0;
    }
  </style>
</head>

<body>
  <!-- ===== Navbar ===== -->
  <nav class="navbar navbar-expand-lg navbar-dark px-3 sticky-top">
    <a class="navbar-brand fw-bold d-flex align-items-center" href="{{ url_for('home') }}">
      <i class="bi bi-building me-2"></i> Holycity Portal
    </a>

    {% if current_user.is_authenticated %}
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarsExample">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">

        <!-- Dashboard -->
        <li class="nav-item">
          <a class="nav-link {% if request.endpoint == 'home' %}active{% endif %}" href="{{ url_for('home') }}">
            <i class="bi bi-house-fill me-1"></i>Dashboard
          </a>
        </li>

        <!-- Absensi -->
        <li class="nav-item">
          <a class="nav-link {% if request.endpoint == 'absensi.absensi_page' %}active{% endif %}" href="{{ url_for('absensi.absensi_page') }}">
            <i class="bi bi-geo-alt-fill me-1"></i>Absensi
          </a>
        </li>

        <!-- HRD -->
        {% if current_user.role in ['admin','hrd'] %}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle {% if 'hrd.' in (request.endpoint|default('')) %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown">
            <i class="bi bi-people-fill me-1"></i>HRD
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ url_for('hrd.dashboard') }}">
              <i class="bi bi-speedometer2 me-1"></i>Dashboard
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('hrd.employee_list') }}">
              <i class="bi bi-person-lines-fill me-1"></i>Data Karyawan
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('hrd.dashboard') }}">
              <i class="bi bi-bar-chart-line me-1"></i>Performance
            </a></li>
            <li><a class="dropdown-item disabled text-muted" href="#">
              <i class="bi bi-graph-up me-1"></i>Report (coming soon)
            </a></li>
          </ul>
        </li>
        {% endif %}

        <!-- Accounting -->
        {% if current_user.role in ['admin','hrd'] %}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle {% if 'accounting.' in (request.endpoint|default('')) %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown">
            <i class="bi bi-cash-stack me-1"></i>Accounting
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ url_for('accounting.dashboard') }}">
              <i class="bi bi-speedometer2 me-1"></i>Dashboard
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('accounting.mutasi') }}">
              <i class="bi bi-journal-text me-1"></i>Mutasi
            </a></li>
          </ul>
        </li>
        {% endif %}

        <!-- Marketing -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle {% if 'marketing.' in (request.endpoint|default('')) %}active{% endif %}"
             href="#" role="button" data-bs-toggle="dropdown">
             <i class="bi bi-bullseye me-1"></i>Marketing
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ url_for('marketing.marketing_dashboard') }}">
              <i class="bi bi-speedometer2 me-1"></i>Dashboard
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('marketing.marketing_leads') }}">
              <i class="bi bi-person-lines-fill me-1"></i>Data Leads
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('marketing.marketing_clients') }}">
              <i class="bi bi-briefcase me-1"></i>Clients
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('marketing.marketing_offer_letter') }}">
              <i class="bi bi-envelope-paper me-1"></i>Offer Letter
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('marketing.marketing_targets') }}">
              <i class="bi bi-bullseye me-1"></i>Targets
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('marketing.marketing_campaigns') }}">
              <i class="bi bi-megaphone me-1"></i>Campaigns
            </a></li>
          </ul>
        </li>

        <!-- Purchasing -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle {% if 'purchasing.' in (request.endpoint|default('')) %}active{% endif %}"
             href="#" role="button" data-bs-toggle="dropdown">
             <i class="bi bi-basket2-fill me-1"></i>Purchasing
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ url_for('purchasing.dashboard') }}">
              <i class="bi bi-speedometer2 me-1"></i>Dashboard
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('purchasing.suppliers') }}">
              <i class="bi bi-box-seam me-1"></i>Data Supplier
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('purchasing.orders') }}">
              <i class="bi bi-cart-check me-1"></i>Purchase Orders
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('purchasing.receipts') }}">
              <i class="bi bi-truck me-1"></i>Penerimaan Barang
            </a></li>
          </ul>
        </li>
      </ul>

      <!-- User Info -->
      <div class="text-white d-flex align-items-center">
        <i class="bi bi-person-circle me-2 fs-5"></i>
        <span class="fw-semibold">{{ current_user.username }}</span>
        <span class="badge bg-light text-dark ms-2">{{ current_user.role|title }}</span>
        <a href="{{ url_for('logout') }}" class="btn btn-light btn-sm ms-3">
          <i class="bi bi-box-arrow-right"></i> Logout
        </a>
      </div>
    </div>
    {% endif %}
  </nav>

  <!-- ===== Content ===== -->
  <div class="container py-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </div>

  <!-- ===== Footer ===== -->
  <footer>
    {% block footer %}
      © {{ now().year }} Holycity Portal – All rights reserved.
    {% endblock %}
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    setTimeout(()=>{
      document.querySelectorAll('.alert').forEach(el=>el.classList.remove('show'));
    },3500);
  </script>

  <!-- ===== Tambahan baru: auto-sisip CSRF token di setiap form POST ===== -->
  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const csrfToken = "{{ csrf_token() }}";
    document.querySelectorAll('form[method="post"]').forEach(form => {
      if (!form.querySelector('input[name="csrf_token"]')) {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'csrf_token';
        hiddenInput.value = csrfToken;
        form.prepend(hiddenInput);
      }
    });
  });
  </script>
</body>
</html>